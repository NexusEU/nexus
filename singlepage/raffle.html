<!DOCTYPE html>
<html>
    <head>
        <title>Raffle</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            $(function() {
                $('#contestants-template').hide();
                addContestant();
                $('#add').click(addContestant);
                $('#draw').click(function(){
                    var tickets = [];
                    var winners = [];
                    var drawsRemaining = parseInt($('#numberofwinners').val());
                    if(!drawsRemaining) drawsRemaining=1;
                    var allowDupes = $('#duplicate').is(":checked");

                    $('#contestants .row').each(function(index){
                        var name = $(this).find('.name').val();
                        
                        if(name.length>0){
                            var newtickets = parseInt($(this).find('.tickets').val());

                            if(!newtickets) newtickets=0;
                            
                            var tmp = Array.apply(null, Array(newtickets)).map(function () {return name;})
                            tickets.push(...tmp);
                        }
                    })

                    while(drawsRemaining>0 && tickets.length>0){
                        var winnerIdx = Math.floor(Math.random()*tickets.length);
                        var winner = tickets[winnerIdx];
                        winners.push(winner);
                        if(!allowDupes) {
                            tickets = tickets.filter(a => a !== winner)
                        }else{
                            tickets.splice(winnerIdx,1);
                        }
                        drawsRemaining--;
                    }

                    $('#result').empty();
                    for(var i = 0; i < winners.length; i++) {
                        $('#result').append( $('<p>').text('#'+(i+1).toString()+": "+winners[i]));
                    }
                    
                })
            });

            function deleteContestant(e) {
                $(e).parent('.row').remove();
            }

            function addContestant() {
                $('#contestants').append($('#contestants-template').clone().show().removeAttr('id'));
            }
        </script>
        <style>
            #main{ width: 95%; margin: 0 auto; max-width: 500px; }
            #contestants { margin-top: 10px; margin-bottom: 10px; clear:both; }
            .namecol{ width: 70%; }
            .ticketcol{ width: 20%; }
            .buttoncol{ width: 10%; }
            .namecol, .ticketcol, .buttoncol { float: left; }
            .row input, .row button { margin-bottom: 5px; }
            #contestants input { width: 95%; margin-right: 5%; }
        </style>
    </head>
    <body>
        <div id="main">
            <h1>Raffle</h1>
            <p>Number of prizes: <input type="number" id="numberofwinners" name="quantity" min="1" max="5" value="1" /></p>
            <p>Allow a single contestant to win multiple prizes: <input type="checkbox" id="duplicate" name="duplicate" /></p>
            <p>Enter contestants</p>
            <div>
                <div class="row">
                    <div class="namecol">Name</div>
                    <div class="ticketcol">Tickets</div>
                    <div class="buttoncol">Del</div>
                </div>
            </div>
            <div id="contestants">

            </div>
            
            <p>
                <div id="contestants-template" class="row">
                    <div class="namecol"><input type="text" class="name" /></div>
                    <div class="ticketcol"><input type="number" class="tickets" min="1" max="10000" /></div>
                    <button class="buttoncol" onclick="deleteContestant(this)">X</button>
                </div>
            </p>

            <p>
                <button id="add">Add contestant</button>
                <button id="draw">Draw</button>
            </p>

            <p id="result"></p>
        </div>
    </body>
</html>
